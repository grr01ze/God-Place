<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Godplace - Connexion</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      padding: 20px;
    }
    #authContainer, #panelContainer {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, button, select {
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      font-size: 16px;
    }
    h2 {
      text-align: center;
      color: #d4af37;
    }
  </style>
</head>
<body>

<!-- üîê Connexion / inscription -->
<div id="authContainer">
  <h2>Connexion</h2>
  <input type="email" id="email" placeholder="Email" required><br>
  <input type="password" id="password" placeholder="Mot de passe" required><br>
  <input type="text" id="pseudoDiscord" placeholder="Pseudo Discord (ex: User#1234)" required><br>
  <button onclick="register()">Cr√©er un compte</button>
  <button onclick="login()">Se connecter</button>
  <p id="authError" style="color:red;"></p>
</div>

<!-- ‚úÖ Panel principal -->
<div id="panelContainer" style="display:none;">
  <h2>Bienvenue sur le panel GodPlace</h2>
  <p id="userInfo"></p>

  <label for="categorySelect">Choisir une cat√©gorie :</label>
  <select id="categorySelect">
    <option value="https://cdn.discordapp.com/attachments/1378679774742056974/1/image1.png">Le monde en d√©clin</option>
    <option value="https://cdn.discordapp.com/attachments/1378679774742056974/2/image2.png">Gagne le c≈ìur du Christ</option>
    <option value="https://cdn.discordapp.com/attachments/1378680922928320653/3/image3.png">Loue avec ton art</option>
    <option value="https://cdn.discordapp.com/attachments/1378680922928320653/4/image4.png">Cha√Æne sacr√©e</option>
  </select>

  <label for="channelSelect">Choisir un salon :</label>
  <select id="channelSelect">
    <option value="1378679774742056974">Grille de lumi√®re</option>
    <option value="1378680922928320653">√âclaireurs</option>
  </select>

  <button onclick="sendImage()">üì§ Envoyer</button>
  <p id="sendStatus"></p>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDuY1T6HaxfDbEcZZYOrpDcD5LPNUTmeUc",
    authDomain: "godplace-dea67.firebaseapp.com",
    projectId: "godplace-dea67",
    storageBucket: "godplace-dea67.appspot.com",
    messagingSenderId: "774010087004",
    appId: "1:774010087004:web:31346dfbc1b2adfed2e899",
    measurementId: "G-HNXY5FDSZK"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const pseudoInput = document.getElementById("pseudoDiscord");

  function isValidDiscordTag(tag) {
    return /^.{2,32}#\d{4}$/.test(tag);
  }

  function showError(message) {
    document.getElementById("authError").textContent = message;
  }

  async function register() {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    const pseudo = pseudoInput.value.trim();

    if (!isValidDiscordTag(pseudo)) return showError("Pseudo Discord invalide (format requis : Nom#1234)");

    try {
      const { user } = await auth.createUserWithEmailAndPassword(email, password);
      await user.updateProfile({ displayName: pseudo });
      showPanel(user);
    } catch (err) {
      showError(err.message);
    }
  }

  async function login() {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    const pseudo = pseudoInput.value.trim();

    if (!isValidDiscordTag(pseudo)) return showError("Pseudo Discord invalide (format requis : Nom#1234)");

    try {
      const { user } = await auth.signInWithEmailAndPassword(email, password);
      if (user.displayName !== pseudo) {
        await user.updateProfile({ displayName: pseudo });
      }
      showPanel(user);
    } catch (err) {
      showError(err.message);
    }
  }

  function showPanel(user) {
    if (!user || !isValidDiscordTag(user.displayName)) {
      return showError("Utilisateur invalide ou pseudo mal format√©");
    }
    document.getElementById("authContainer").style.display = "none";
    document.getElementById("panelContainer").style.display = "block";
    document.getElementById("userInfo").textContent = `Connect√© en tant que : ${user.displayName}`;
  }

  auth.onAuthStateChanged(user => {
    if (user && isValidDiscordTag(user.displayName)) {
      showPanel(user);
    }
  });

  async function sendImage() {
    const channelId = document.getElementById("channelSelect").value;
    const imageUrl = document.getElementById("categorySelect").value;

    try {
      const res = await fetch("https://bot-production-e4ec.up.railway.app/send", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ channelId, imageUrl })
      });

      const result = await res.text();
      document.getElementById("sendStatus").textContent = res.ok ? "‚úÖ Envoy√© !" : `‚ùå Erreur : ${result}`;
    } catch (err) {
      document.getElementById("sendStatus").textContent = `‚ùå Erreur de connexion : ${err.message}`;
    }
  }
</script>

</body>
</html>
