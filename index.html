<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Godplace - Connexion</title>
  <style>
    body {
      font-family: sans-serif;
      background: #000;
      padding: 20px;
      color: white;
    }
    #authContainer, #panelContainer {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      color: black;
    }
    input, button, select {
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      font-size: 16px;
      box-sizing: border-box;
    }
    h2, h3 {
      text-align: center;
      color: #d4af37;
    }
    button.logout {
      background-color: #d9534f;
      color: white;
      border: none;
      cursor: pointer;
    }
    button.logout:hover {
      background-color: #c9302c;
    }
  </style>
</head>
<body>

<div id="authContainer">
  <h2>Connexion</h2>
  <input type="email" id="email" placeholder="Email" required />
  <input type="password" id="password" placeholder="Mot de passe" required />
  <input type="text" id="pseudoDiscord" placeholder="Pseudo Discord (ex: User_1234)" required />
  <button id="btnRegister">Créer un compte</button>
  <button id="btnLogin">Se connecter</button>
  <p id="authError" style="color:red;"></p>
</div>

<div id="panelContainer" style="display:none;">
  <h2>Bienvenue sur le panel GodPlace</h2>
  <button class="logout" id="btnLogout">Déconnexion</button>
  <label for="channelSelect">Choisis un salon :</label>
  <select id="channelSelect"></select>
  <div id="categoriesContainer"></div>
  <p id="sendStatus" style="color:red;"></p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    updateProfile,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDuY1T6HaxfDbEcZZYOrpDcD5LPNUTmeUc",
    authDomain: "godplace-dea67.firebaseapp.com",
    projectId: "godplace-dea67",
    storageBucket: "godplace-dea67.appspot.com",
    messagingSenderId: "774010087004",
    appId: "1:774010087004:web:31346dfbc1b2adfed2e899"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const availableChannels = {
    "1378679774742056974": "Salon Grille de lumière",
    "1378680922928320653": "Salon Éclaireurs",
    "1325922071473295411": "Salon Général",
    "1378679000000000001": "Salon Annonces",
    "1365417738436087909": "Je préfères G1",
    "1365417832774635540": "Je préfères G2",
  };

  const categories = {
    mondeEnDeclin: {
      "Semaine 1": "https://media.discordapp.net/attachments/1365412596655853699/1365725262414876693/FICHES_SPECIFIQUES_PETIT_FORMAT_-_4.png",
      "Semaine 2": "https://media.discordapp.net/attachments/1365412596655853699/1365725295369388042/FICHES_SPECIFIQUES_PETIT_FORMAT_-_5.png",
      "Semaine 3": "https://media.discordapp.net/attachments/1365412596655853699/1365725348314222754/FICHES_SPECIFIQUES_PETIT_FORMAT_-_6.png",
    },
    // Ajoute ici les autres catégories si besoin
  };

  // Récupération des éléments du DOM
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const pseudoInput = document.getElementById("pseudoDiscord");
  const authError = document.getElementById("authError");
  const sendStatus = document.getElementById("sendStatus");
  const authContainer = document.getElementById("authContainer");
  const panelContainer = document.getElementById("panelContainer");
  const channelSelect = document.getElementById("channelSelect");
  const categoriesContainer = document.getElementById("categoriesContainer");
  const btnRegister = document.getElementById("btnRegister");
  const btnLogin = document.getElementById("btnLogin");
  const btnLogout = document.getElementById("btnLogout");

  // Validation pseudo Discord : lettres, chiffres, underscore, 2 à 32 caractères, sans espaces
  function isValidDiscordTag(tag) {
    return /^[\w]{2,32}$/.test(tag);
  }

  function showError(msg) {
    authError.textContent = msg;
  }

  function clearError() {
    authError.textContent = "";
  }

  function showPanel() {
    authContainer.style.display = "none";
    panelContainer.style.display = "block";
    fillChannels();
    loadCategories();
    sendStatus.textContent = "";
  }

  function showAuth() {
    authContainer.style.display = "block";
    panelContainer.style.display = "none";
    clearError();
    sendStatus.textContent = "";
    emailInput.value = "";
    passwordInput.value = "";
    pseudoInput.value = "";
  }

  function fillChannels() {
    channelSelect.innerHTML = "";
    for (const id in availableChannels) {
      const option = document.createElement("option");
      option.value = id;
      option.textContent = availableChannels[id];
      channelSelect.appendChild(option);
    }
  }

  function loadCategories() {
    categoriesContainer.innerHTML = "";
    for (const category in categories) {
      const div = document.createElement("div");
      div.innerHTML = `<h3>${category}</h3>`;
      for (const label in categories[category]) {
        const url = categories[category][label];
        const btn = document.createElement("button");
        btn.textContent = label;
        btn.style.margin = "5px";
        btn.onclick = () => sendImage(url);
        div.appendChild(btn);
      }
      categoriesContainer.appendChild(div);
    }
  }

  async function sendImage(imageUrl) {
    const channelId = channelSelect.value;
    sendStatus.style.color = "black";
    sendStatus.textContent = "Envoi en cours...";

    try {
      const response = await fetch("https://bot-production-e4ec.up.railway.app/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ channelId, imageUrl })
      });

      if (!response.ok) {
        throw new Error("Erreur lors de l'envoi");
      }
      sendStatus.style.color = "green";
      sendStatus.textContent = "Image envoyée avec succès ✅";
    } catch (error) {
      sendStatus.style.color = "red";
      sendStatus.textContent = error.message;
    }
  }

  btnRegister.onclick = async () => {
    clearError();
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    const pseudo = pseudoInput.value.trim();

    if (!email || !password || !pseudo) {
      return showError("Tous les champs sont requis.");
    }
    if (!isValidDiscordTag(pseudo)) {
      return showError("Pseudo Discord invalide (lettres, chiffres, underscore, 2-32 caractères).");
    }

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      await updateProfile(userCredential.user, { displayName: pseudo });
      showPanel();
    } catch (error) {
      showError(error.message);
    }
  };

  btnLogin.onclick = async () => {
    clearError();
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    const pseudo = pseudoInput.value.trim();

    if (!email || !password || !pseudo) {
      return showError("Tous les champs sont requis.");
    }
    if (!isValidDiscordTag(pseudo)) {
      return showError("Pseudo Discord invalide (lettres, chiffres, underscore, 2-32 caractères).");
    }

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      if (userCredential.user.displayName !== pseudo) {
        await updateProfile(userCredential.user, { displayName: pseudo });
      }
      showPanel();
    } catch (error) {
      showError(error.message);
    }
  };

  btnLogout.onclick = async () => {
    await signOut(auth);
    showAuth();
  };

  onAuthStateChanged(auth, (user) => {
    if (user && isValidDiscordTag(user.displayName)) {
      showPanel();
    } else {
      showAuth();
    }
  });
</script>

</body>
</html>
