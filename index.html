<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Godplace - Connexion</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #000;
      padding: 20px;
      color: black;
    }
    #authContainer, #panelContainer {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    input, button, select {
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      font-size: 16px;
    }
    h2, h3 {
      text-align: center;
      color: #d4af37;
    }
  </style>
</head>
<body>
<div id="authContainer">
  <h2>Connexion</h2>
  <input type="email" id="email" placeholder="Email" required><br>
  <input type="password" id="password" placeholder="Mot de passe" required><br>
  <input type="text" id="pseudoDiscord" placeholder="Pseudo Discord (ex: User1234)" required><br>
  <button onclick="register()">Créer un compte</button>
  <button onclick="login()">Se connecter</button>
  <p id="authError" style="color:red;"></p>
</div>

<div id="panelContainer" style="display:none;">
  <h2>Bienvenue sur le panel GodPlace</h2>
  <label for="channelSelect">Choisis un salon :</label>
  <select id="channelSelect"></select>
  <div id="categoriesContainer"></div>
  <p id="sendStatus" style="color:red;"></p>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDuY1T6HaxfDbEcZZYOrpDcD5LPNUTmeUc",
  authDomain: "godplace-dea67.firebaseapp.com",
  projectId: "godplace-dea67",
  storageBucket: "godplace-dea67.appspot.com",
  messagingSenderId: "774010087004",
  appId: "1:774010087004:web:31346dfbc1b2adfed2e899"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

const availableChannels = {
  "1378679774742056974": "Salon Grille de lumière",
  "1378680922928320653": "Salon Éclaireurs",
  "1325922071473295411": "Salon Général",
  "1378679000000000001": "Salon Annonces",
  "1365417738436087909": "Je préfères G1",
  "1365417832774635540": "Je préfères G2",
};

function isValidDiscordTag(tag) {
  return /^[\w\s]{2,32}$/.test(tag); // plus de # obligatoire
}

function showError(msg) {
  document.getElementById("authError").textContent = msg;
}

async function register() {
  const email = emailInput.value;
  const password = passwordInput.value;
  const pseudo = pseudoInput.value;
  if (!isValidDiscordTag(pseudo)) return showError("Pseudo Discord invalide");
  try {
    const { user } = await auth.createUserWithEmailAndPassword(email, password);
    await user.updateProfile({ displayName: pseudo });
    showPanel();
  } catch (err) {
    showError(err.message);
  }
}

async function login() {
  const email = emailInput.value;
  const password = passwordInput.value;
  const pseudo = pseudoInput.value;
  if (!isValidDiscordTag(pseudo)) return showError("Pseudo Discord invalide");
  try {
    const { user } = await auth.signInWithEmailAndPassword(email, password);
    if (user.displayName !== pseudo) await user.updateProfile({ displayName: pseudo });
    showPanel();
  } catch (err) {
    showError(err.message);
  }
}

function showPanel() {
  document.getElementById("authContainer").style.display = "none";
  document.getElementById("panelContainer").style.display = "block";
  fillChannels();
  loadCategories();
}

function fillChannels() {
  const select = document.getElementById("channelSelect");
  select.innerHTML = "";
  for (const id in availableChannels) {
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = availableChannels[id];
    select.appendChild(opt);
  }
}

function loadCategories() {
  const container = document.getElementById("categoriesContainer");
  container.innerHTML = "";
  for (const category in categories) {
    const div = document.createElement("div");
    div.innerHTML = `<h3>${category}</h3>`;
    for (const label in categories[category]) {
      const url = categories[category][label];
      const btn = document.createElement("button");
      btn.textContent = label;
      btn.onclick = () => sendImage(url);
      div.appendChild(btn);
    }
    container.appendChild(div);
  }
}

async function sendImage(imageUrl) {
  const channelId = document.getElementById("channelSelect").value;
  const response = await fetch("https://bot-production-e4ec.up.railway.app/send", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ channelId, imageUrl })
  });
  const status = document.getElementById("sendStatus");
  if (!response.ok) {
    status.textContent = "Erreur lors de l'envoi";
  } else {
    status.textContent = "Image envoyée avec succès ✅";
  }
}

const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const pseudoInput = document.getElementById("pseudoDiscord");

auth.onAuthStateChanged(user => {
  if (user && isValidDiscordTag(user.displayName)) {
    showPanel();
  }
});

// Données des catégories (ajoutées dynamiquement ici ensuite)
const categories = {};
</script>
</body>
</html>
